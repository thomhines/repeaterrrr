var timer_interval,current_step,current_seconds,prev_seconds,next_step,prev_time,sound_start,sound_length,step_seconds=0,total_seconds=0,total_seconds_so_far=0;$((function(){if("undefined"!=typeof createjs&&(createjs.Sound.registerSound("audio/tick.mp3","tick"),createjs.Sound.registerSound("audio/single.mp3","single"),createjs.Sound.registerSound("audio/double.mp3","double"),createjs.Sound.registerSound("audio/triple.mp3","triple"),createjs.Sound.registerSound("audio/long.mp3","short"),createjs.Sound.registerSound("audio/finished.mp3","long")),$(".timer").length){if($("body").on("touchmove",(function(e){e.preventDefault()})),$(".button").bind("touchstart",(function(){$(this).addClass("button_hover")})),$(".button").bind("touchend",(function(){$(this).removeClass("button_hover")})),$(".timer").length)for(var e=0;e<steps.length;e++)total_seconds+=parseInt(steps[e].time);r(),$(".ready h5").html($(".ready h5").html().replace(/\[([^\]]*)]\(([^)]*)\)/g,'<a href="$2" target="$1">$1</a>').replace(/\*\*(.*)\*\*/g,"<b>$1</b>").replace(/\*(.*)\*/g,"<i>$1</i>")),window.navigator.standalone&&$(".ios").remove()}var t;function s(){if($(".timer").fadeIn(300),current_seconds<=0)n();else{var e=100-current_seconds/step_seconds*100;e>100&&(e=100),function(){if(remaining_seconds=Math.ceil(current_seconds),t==remaining_seconds)return null;if(step_seconds>99){var e=Math.floor(current_seconds/60),s=Math.floor(current_seconds%60);s<10&&(s="0"+s);var n=Math.floor(step_seconds/60),r=Math.ceil(step_seconds%60);r<10&&(r="0"+r),$(".clock").html('<span class="seconds">'+e+":"+s+'</span>/<span class="total">'+n+":"+r+"</span>")}else $(".clock").html('<span class="seconds">'+remaining_seconds+'</span>/<span class="total">'+step_seconds+"</span> seconds");$("title").html($(".seconds").text()+" | "+steps[current_step].title),t=remaining_seconds}()}step_seconds>=25?$(".current_progress span").css({width:e+"%"}):$(".current_progress span").animate({width:e+"%"},90),$(".total_progress span").css({width:total_seconds_so_far/total_seconds*100+"%"}),Math.ceil(current_seconds)==Math.ceil(prev_seconds)||2!=Math.ceil(current_seconds)&&1!=Math.ceil(current_seconds)||a("tick"),prev_seconds=current_seconds;var s=((new Date).getTime()-prev_time.getTime())/1e3;prev_time=new Date,current_seconds-=s,total_seconds_so_far+=s}function n(){for(total_seconds_so_far=0,e=0;e<current_step+1;e++)total_seconds_so_far+=steps[e].time;if($(".current_progress span").stop().animate({width:"0"},30),current_step==steps.length-1){if(a("long"),clearInterval(timer_interval),$("body").attr("class",""),$("body").addClass("white"),$(".progress_bar span").stop().css({width:"100%"}),step_seconds>99){var t=Math.floor(step_seconds/60),s=Math.ceil(step_seconds%60);s<10&&(s="0"+s),$(".clock").html('<span class="seconds">0:00</span>/<span class="total">'+t+":"+s+"</span>")}else $(".clock").html('<span class="seconds">0</span>/<span class="total">'+step_seconds+"</span> seconds");$(".timer").fadeOut(1e3,(function(){$(".complete").fadeIn(300),r()})),$("title").html("repeaterrrr | "+$(".ready h2").text())}else current_step++,current_seconds=steps[current_step].time,step_seconds=current_seconds,steps[current_step].sound&&a(steps[current_step].sound),$(".current_activity").html(steps[current_step].title),r(),$("body").attr("class",""),$("body").addClass(steps[current_step].color),$(".total").html(step_seconds),steps[current_step+1]?$(".next_activity").html(steps[current_step+1].title):$(".next_activity").html("DONE!")}function r(){$("h2:visible").each((function(){$(this).text().length<10?$(this).css("font-size","3.1em"):$(this).text().length<15?$(this).css("font-size","2.25em"):$(this).text().length<20?$(this).css("font-size","1.75em"):$(this).text().length<25?$(this).css("font-size","2.5em"):$(this).text().length<35?$(this).css("font-size","1.1em"):$(this).text().length<45&&$(this).css("font-size",".9em")}))}function a(e){createjs.Sound.play(e)}function i(){var e="",t=!1;$(".steps li").each((function(){var e=$(this),s=e.find(".name").val(),n=e.find(".time").val();s&&n>0?($(this).removeClass("incomplete"),e.find(".field_error").removeClass("has_error")):(t=!0,e.addClass("incomplete"),s?e.find(".name_error").removeClass("has_error"):e.find(".name_error").addClass("has_error"),!n||n<1?e.find(".time_error").addClass("has_error"):e.find(".time_error").removeClass("has_error"))})),t?e="Make sure all of your steps are filled in.":""==$(".title").val()&&(e="This timer needs a title!"),$(".error_message").html(e),e?$(".save, .save_as_new, .short_url, .copy_url, .email_timer").addClass("disabled"):$(".save, .save_as_new, .short_url, .copy_url, .email_timer").removeClass("disabled")}function o(e){if(!e)return"";var t=e.replace(/(["])/g,"\\$1");return t=(t=t.replace(/#/g,"%23")).replace(/&/g,"%26")}$(".start").click((function(){!function(){current_step=-1,current_seconds=0,step_seconds=0,prev_time=new Date,total_seconds_so_far=0,next_step=steps[1]?steps[1].title:"DONE!";$(".current_activity").html(steps[0].title),$(".next_activity").html(next_step),r(),$(".progress_bar span").width(0),$(".ready").is(":visible")?$(".ready").fadeOut(300,(function(){timer_interval=setInterval(s,100)})):$(".complete").fadeOut(300,(function(){timer_interval=setInterval(s,100)}))}()})),$(".skip").click((function(){n()})),$(".pause").click((function(){"pause"==$(".pause").text().trim()?(clearInterval(timer_interval),$(".pause").html('<i class="icon-play"></i> resume')):(timer_interval=setInterval(s,100),$(".pause").html('<i class="icon-pause"></i> pause'),prev_time=new Date)})),$(".email_timer").click((function(e){e.preventDefault(),emailLink()})),$(".mute").click((function(){$(this).hasClass("muted")?$(this).attr("class","mute").addClass("icon-volume-up"):$(this).attr("class","mute muted").addClass("icon-volume-off")})),$(".sounds").length&&$(".sounds").get(0).addEventListener("timeupdate",(function(){$(".sounds").get(0).currentTime>=sound_start+sound_length&&$(".sounds").get(0).pause()}),!1),$(".editor").length&&(i(),$(document).on("change keyup paste","input:not(.timer_url), textarea, select",(function(){i()})),$(document).on("change","select.color",(function(){$(this).closest("li").attr("class","step "+$(this).val()),i()})),$(".title_char_count").html($(".title").val().length),$(".title").keyup((function(e){$(".title_char_count").html($(".title").val().length)})),$(".description_char_count").html($(".description").val().length),$(".description").keyup((function(){$(".description_char_count").html($(".description").val().length)})),$(".steps").sortable({handle:".drag_handle"}),$(".add_step").click((function(e){e.preventDefault(),$(".row_template").clone().appendTo(".steps").removeClass("row_template"),$(".incomplete .name").focus(),i()})),$(document).on("click",".copy_step",(function(e){e.preventDefault(),$li=$(this).closest("li"),$clone=$li.clone(),$clone.insertAfter($li),$clone.find(".name").focus(),i()})),$(document).on("click",".delete_step",(function(e){e.preventDefault(),$(this).closest("li").fadeOut(300,(function(){$(this).remove(),i()}))})),$(document).on("click",".save:not(.disabled)",(function(e){e.preventDefault();var t=function(){repeats_x_times=$(".repeat").val(),repeats_x_times||(repeats_x_times=1);var e='{"info":{"title":"'+o($(".title").val())+'","description":"'+o($(".description").val())+'","repeat":'+repeats_x_times+'},"steps":[',t=!1;$("li").each((function(){$(this).find(".name").val()&&$(this).find(".time").val()&&(e+='{"title":"'+o($(this).find(".name").val())+'","time":'+$(this).find(".time").val()+',"color":"'+$(this).find(".color").val()+'","sound":"'+$(this).find(".tone").val()+'"},',t=!0)})),t||$(".error_message").html("This timer needs at least one working step!");return e=e.substring(0,e.length-1),e+="]}"}();$(this).addClass("working").html("Saving..."),$.ajax({type:"POST",url:"/ajax.php",data:{json:t,slug:window.location.pathname.substr(6)}}).done((function(e){window.location="/"+e}))})))}));